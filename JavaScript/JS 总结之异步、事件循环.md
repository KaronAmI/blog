# JS æ€»ç»“ä¹‹å¼‚æ­¥ã€äº‹ä»¶å¾ªç¯

ä¼—æ‰€å‘¨çŸ¥ï¼ŒJavaScript ä¸ºäº†é¿å…å¤æ‚ï¼Œè¢«è®¾è®¡æˆäº†å•çº¿ç¨‹ã€‚

## â›…ï¸ ä»»åŠ¡

å•çº¿ç¨‹æ„å‘³ç€æ‰€æœ‰ä»»åŠ¡éƒ½éœ€è¦æŒ‰é¡ºåºæ‰§è¡Œï¼Œå¦‚æœæŸä¸ªä»»åŠ¡æ‰§è¡Œéå¸¸è€—æ—¶ï¼Œçº¿ç¨‹å°±ä¼šè¢«é˜»æ–­ï¼Œåé¢çš„ä»»åŠ¡éœ€è¦ç­‰ä¸Šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•æ‰ä¼šè¿›è¡Œã€‚è€Œå¤§å¤šæ•°éå¸¸è€—æ—¶çš„ä»»åŠ¡æ˜¯ç½‘ç»œè¯·æ±‚ï¼ŒCPU æ˜¯é—²ç€çš„ï¼Œæ‰€ä»¥ä¸ºäº†èµ„æºçš„å……åˆ†è¿ç”¨ï¼Œä¾¿æœ‰äº†å¼‚æ­¥çš„æ¦‚å¿µã€‚

å¼‚æ­¥ä¾¿æ˜¯æŠŠè¿™äº›éå¸¸è€—æ—¶çš„ä»»åŠ¡æ”¾åˆ°ä¸€è¾¹ï¼Œå…¶ä»–ä»»åŠ¡å…ˆè¿›è¡Œï¼Œç­‰å¤„ç†å®Œå…¶å®ƒä¸éœ€è¦ç­‰å¾…çš„ä»»åŠ¡å†å›å¤´æ¥è®¡ç®—åˆšåˆšè¢«æ”¾ä¸€è¾¹çš„ä»»åŠ¡ã€‚è¿™æ ·å°±ä¸ä¼šé˜»æ–­çº¿ç¨‹å•¦ã€‚

å°±åƒä¸Šé¢è®²è¿°çš„ï¼Œåé¢çš„ä»»åŠ¡éœ€è¦ç­‰ä¸Šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•æ‰ä¼šè¿›è¡Œï¼Œå«**åŒæ­¥ä»»åŠ¡**ï¼›æŠŠè¿™äº›éå¸¸è€—æ—¶çš„ä»»åŠ¡æ”¾åˆ°ä¸€è¾¹ï¼Œå…¶ä»–ä»»åŠ¡å…ˆè¿›è¡Œï¼Œå«**å¼‚æ­¥ä»»åŠ¡**ã€‚

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œ**æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡åä¼šå‘ç”Ÿä»€ä¹ˆ**ï¼Ÿ

## â˜ï¸ ä»»åŠ¡é˜Ÿåˆ—

åœ¨ä¸»çº¿ç¨‹ä¹‹å¤–å­˜åœ¨ä¸€ä¸ª**ä»»åŠ¡é˜Ÿåˆ—**ã€‚

å½“å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œä¼šå°†ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼ˆå›è°ƒå‡½æ•°æ˜¯åœ¨ç¼–å†™å¼‚æ­¥ä»»åŠ¡æ—¶æŒ‡å®šçš„ï¼Œç”¨æ¥å¤„ç†å¼‚æ­¥çš„ç»“æœï¼‰æ¨å…¥**ä»»åŠ¡é˜Ÿåˆ—**ï¼Œè¿™äº›å›è°ƒå‡½æ•°æ ¹æ®ç±»å‹ä¸åŒè¢«åˆ†é…åˆ° **task** å’Œ **microtask** ä¸­ï¼Œæœ€å…ˆè¢«æ¨å…¥çš„å‡½æ•°å…ˆè¢«æ¨å…¥ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œæ˜¯å…ˆè¿›å…ˆå‡ºçš„æ•°æ®ç»“æ„ã€‚ç”±äºæœ‰å®šæ—¶å™¨è¿™ç±»åŠŸèƒ½ï¼Œä¸»çº¿ç¨‹ä¸€èˆ¬è¦æ£€æŸ¥æ—¶é—´åï¼ŒæŸäº›ä»»åŠ¡æ‰ä¼šè¢«æ‰§è¡Œã€‚

## ğŸŒ§ äº‹ä»¶å¾ªç¯

ä¸€æ—¦ä¸»çº¿ç¨‹æ²¡ä»»åŠ¡äº†ï¼ŒJavaScript å¼•æ“å°±ä¼šå»è¯»å–ä»»åŠ¡é˜Ÿåˆ—ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šå¾ªç¯ä¸æ–­ï¼Œè¢«å«åšäº‹ä»¶å¾ªç¯ã€‚

ç”¨å›¾è¡¨ç¤ºï¼š

![eventLoop](Image/eventLoop.png)

## ğŸŒ© setTimeoutã€setInterval

ä¸Šæ–‡è®²çš„å®šæ—¶åŠŸèƒ½ï¼Œä¾é  setTimeoutã€setInterval æä¾›çš„å®šæ—¶åŠŸèƒ½ï¼ŒåŒºåˆ«åœ¨äº setTimeout åœ¨æŒ‡å®šæ—¶é—´åæ‰§è¡Œä¸€æ¬¡ï¼Œè€Œ setInterval åˆ™é‡å¤æ‰§è¡Œã€‚

setTimeout åœ¨ä»»åŠ¡é˜Ÿåˆ—å°¾éƒ¨æ·»åŠ äº†ä¸€ä¸ªäº‹ä»¶ï¼Œåœ¨è®¾å®šçš„æ—¶é—´åæ‰§è¡Œã€‚ä½†å®é™…æ²¡æœ‰è¿™ä¹ˆç†æƒ³ï¼Œå½“ä»»åŠ¡é˜Ÿåˆ—å‰é¢çš„ä»»åŠ¡éå¸¸è€—æ—¶ï¼Œå›è°ƒå‡½æ•°ä¸ä¸€å®šåœ¨è®¾ç½®çš„æ—¶é—´è¿è¡Œã€‚

æ‰€ä»¥å¸¸è§çš„å†™æ³• setTimeout(fn, 0)ï¼Œæ˜¯æŒ‡å®šæŸä¸ªä»»åŠ¡åœ¨ä¸»çº¿ç¨‹æœ€æ—©å¯å¾—çš„ç©ºé—²æ—¶é—´æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå°½å¯èƒ½æ—©å¾—æ‰§è¡Œã€‚

(æ³¨æ„ï¼šHTML5 æ ‡å‡†è§„å®šäº† setTimeout çš„ç¬¬äºŒä¸ªå‚æ•°çš„æœ€å°å€¼ï¼ˆæœ€çŸ­é—´éš”ï¼‰ï¼Œä¸å¾—ä½äº 4 æ¯«ç§’ï¼Œå¦‚æœä½äºè¿™ä¸ªå€¼ï¼Œå°±ä¼šè‡ªåŠ¨å¢åŠ ã€‚)

## â›ˆ task ä¸ microtask

äº‹ä»¶å¾ªç¯ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ª task é˜Ÿåˆ—ï¼Œä¸€ä¸ª microtask é˜Ÿåˆ—ã€‚

äº‹ä»¶å¾ªç¯ä¼šä¸æ–­çš„å»å– task é˜Ÿåˆ—ä¸­æœ€è€çš„ä¸€ä¸ªä»»åŠ¡æ¨å…¥js ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œå½“ä¸»çº¿ç¨‹ä¸ºç©ºçš„æ—¶å€™ï¼Œä¾¿æ‰§è¡Œå®Œmicrotaské˜Ÿåˆ—é‡Œé¢çš„ä»»åŠ¡ã€‚

### ğŸŒ± æº

taskï¼š

- DOMæ“ä½œä»»åŠ¡ï¼šä»¥éé˜»å¡æ–¹å¼æ’å…¥æ–‡æ¡£
- ç”¨æˆ·äº¤äº’ä»»åŠ¡ï¼šé¼ æ ‡é”®ç›˜äº‹ä»¶ã€ç”¨æˆ·è¾“å…¥äº‹ä»¶
- ç½‘ç»œä»»åŠ¡
- IndexDB æ•°æ®åº“æ“ä½œç­‰ I/O
- setTimeout / setInterval
- history.back
- setImmediate

microtask
- Promise.then
- MutationObserver
- Object.observe
- process.nextTick

ç”¨å›¾è¡¨ç¤ºï¼š

![eventLoop](Image/microtasks.png)



### ğŸŒ¿ ä¸¾ä¸ªä¾‹å­

```js
console.log(1)

setTimeout(() => {
  console.log(2)
}, 0)

new Promise(solve => {
  console.log(3)
  solve()
}).then(() => {
  console.log(4)
  setTimeout(() => {
    console.log(5)
  }, 0)
})
```

ç¬¬1è½®ï¼š
1. ä»£ç è¿è¡Œï¼Œæ‰“å° 1
2. callback(2) å›è°ƒ è¢«åˆ†é…åˆ° task

| task        | microtask |
| ----------- | --------- |
| callback(2) |           |

3. æ‰§è¡Œ new Promiseï¼Œæ‰“å° 3
4. é‡åˆ° callback(4) è¢«åˆ†é…åˆ° microtask

| task        | microtask   |
| ----------- | ----------- |
| callback(2) | callback(4) |

5. å½“å‰ task æ‰§è¡Œå®Œæ¯•ï¼Œæ‰§è¡Œ microtask é‡Œçš„ä»»åŠ¡ callback(4)ï¼Œæ‰“å° 4ï¼Œé‡åˆ° callback(5) è¢«åˆ†é…åˆ° task

| task        | microtask |
| ----------- | --------- |
| callback(2) |           |
| callback(5) |           |


ç¬¬1è½®æ‰§è¡Œå®Œæ¯•ï¼Œæ‰“å°ï¼š1ï¼Œ3ï¼Œ4

ç¬¬2è½®ï¼š
1. æ£€æŸ¥ taskï¼Œå‘ç°æœ‰ callback(2)ï¼Œæ‰“å°2
2. æ— microtask

ç¬¬2è½®æ‰§è¡Œå®Œæ¯•ï¼Œæ‰“å°ï¼š1ï¼Œ3ï¼Œ4ï¼Œ2

| task        | microtask |
| ----------- | --------- |
| callback(5) |           |

ç¬¬3è½®ï¼š
1. æ£€æŸ¥ taskï¼Œå‘ç°æœ‰ callback(5)ï¼Œæ‰“å°5
2. æ— microtask

ç¬¬3è½®æ‰§è¡Œå®Œæ¯•ï¼Œæ‰“å°ï¼š1ï¼Œ3ï¼Œ4ï¼Œ2ï¼Œ5

### â˜˜ é—®é¢˜ 1

å¦‚æœæ‰§è¡Œ microtask æ—¶åˆé‡åˆ°äº† microtask æ€ä¹ˆä¸ªæ’åºï¼Ÿ

å¦‚æœ microtask åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°äº† microtaskï¼Œä¼šå°†å…¶æ”¾å…¥ microtask é˜Ÿåˆ—åé¢ï¼Œä¸€èµ·æ‰§è¡Œã€‚

æ”¹ä¸‹ä¸Šé¢çš„ä¾‹å­ï¼š

```js
console.log(1)

setTimeout(() => {
  console.log(2)
}, 0)

new Promise(solve => {
  console.log(3)
  solve()
}).then(() => {
  console.log(4)
  new Promise(solve => {
    console.log(5)
    solve()
  }).then(() => {
    console.log(6)
  })
})
```

è¿è¡Œç»“æœä¸ºï¼š1 3 4 5 6 2

ç¬¬1è½®ï¼š
1. ä»£ç è¿è¡Œï¼Œæ‰“å° 1
2. callback(2) å›è°ƒ è¢«åˆ†é…åˆ° task

| task        | microtask |
| ----------- | --------- |
| callback(2) |           |

3. æ‰§è¡Œ new Promise æ‰“å° 3
4. é‡åˆ° callback(4) è¢«åˆ†é…åˆ° microtask

| task        | microtask   |
| ----------- | ----------- |
| callback(2) | callback(4) |

5. å½“å‰ task æ‰§è¡Œå®Œæ¯•ï¼Œæ‰§è¡Œ microtask é‡Œçš„ä»»åŠ¡ callback(4) æ‰“å° 4ï¼Œé‡åˆ° new Promise æ‰“å° 5ï¼Œ**é‡åˆ° callback(6) è¢«åˆ†é…åˆ° microtask**


6. ä¸»çº¿ç¨‹ç»§ç»­æ£€æŸ¥ microtaskï¼Œå‘ç°è¿˜æœ‰ callback(6) æ‰“å° 6

ç¬¬1è½®æ‰§è¡Œå®Œæ¯•ï¼Œæ‰“å°ï¼š1ï¼Œ3ï¼Œ4ï¼Œ5ï¼Œ6

ç¬¬2è½®ï¼š

| task        | microtask |
| ----------- | --------- |
| callback(2) |           |

1. æ£€æŸ¥ taskï¼Œå‘ç°æœ‰ callback(2)ï¼Œæ‰“å°2
2. æ— microtask

ç¬¬2è½®æ‰§è¡Œå®Œæ¯•ï¼Œæ‰“å°ï¼š1ï¼Œ3ï¼Œ4ï¼Œ5ï¼Œ6ï¼Œ2

### ğŸ€ é—®é¢˜ 2

ä¸ºä»€ä¹ˆéœ€è¦ microtaskï¼Ÿ

æ ¹æ® HTML Standardï¼Œåœ¨æ¯ä¸ª task è¿è¡Œå®Œä»¥åï¼ŒUI éƒ½ä¼šé‡æ¸²æŸ“ï¼Œé‚£ä¹ˆåœ¨ microtask ä¸­å°±å®Œæˆæ•°æ®æ›´æ–°ï¼Œå½“å‰ task ç»“æŸå°±å¯ä»¥å¾—åˆ°æœ€æ–°çš„ UI äº†ã€‚åä¹‹å¦‚æœæ–°å»ºä¸€ä¸ª task æ¥åšæ•°æ®æ›´æ–°ï¼Œé‚£ä¹ˆæ¸²æŸ“å°±ä¼šè¿›è¡Œä¸¤æ¬¡ã€‚

## ğŸš€ å‚è€ƒ

- [ä»event loopè§„èŒƒæ¢ç©¶javaScriptå¼‚æ­¥åŠæµè§ˆå™¨æ›´æ–°æ¸²æŸ“æ—¶æœº](https://github.com/aooy/blog/issues/5) by æ¨æ•¬å“
- [æ·±å…¥æ¢ç©¶ eventloop ä¸æµè§ˆå™¨æ¸²æŸ“çš„æ—¶åºé—®é¢˜](https://github.com/jin5354/404forest/issues/61) by An Yan
- [JavaScript è¿è¡Œæœºåˆ¶è¯¦è§£ï¼šå†è°ˆ Event Loop](http://www.ruanyifeng.com/blog/2014/10/event-loop.html) by é˜®ä¸€å³°
- [è¿™ä¸€æ¬¡ï¼Œå½»åº•å¼„æ‡‚ JavaScript æ‰§è¡Œæœºåˆ¶](https://juejin.im/post/59e85eebf265da430d571f89) by ssssyoki
- [å…³äº task å’Œ microtask çš„é—®ç­”](https://www.zhihu.com/question/55364497/answer/144215284) by é¡¾è½¶çµ
