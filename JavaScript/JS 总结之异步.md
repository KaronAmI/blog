# JS æ€»ç»“ä¹‹å¼‚æ­¥

ä¼—æ‰€å‘¨çŸ¥ï¼ŒJavaScript ä¸ºäº†é¿å…å¤æ‚ï¼Œè¢«è®¾è®¡æˆäº†å•çº¿ç¨‹ã€‚

## â›…ï¸ ä»»åŠ¡

å•çº¿ç¨‹æ„å‘³ç€æ‰€æœ‰ä»»åŠ¡éƒ½éœ€è¦æŒ‰é¡ºåºæ‰§è¡Œï¼Œå¦‚æœæŸä¸ªä»»åŠ¡æ‰§è¡Œéå¸¸è€—æ—¶ï¼Œçº¿ç¨‹å°±ä¼šè¢«é˜»æ–­ï¼Œåé¢çš„ä»»åŠ¡éœ€è¦ç­‰ä¸Šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•æ‰ä¼šè¿›è¡Œã€‚è€Œå¤§å¤šæ•°éå¸¸è€—æ—¶çš„ä»»åŠ¡æ˜¯ç½‘ç»œè¯·æ±‚ï¼ŒCPU æ˜¯é—²ç€çš„ï¼Œæ‰€ä»¥ä¸ºäº†èµ„æºçš„å……åˆ†è¿ç”¨ï¼Œä¾¿æœ‰äº†å¼‚æ­¥çš„æ¦‚å¿µã€‚

å¼‚æ­¥ä¾¿æ˜¯æŠŠè¿™äº›éå¸¸è€—æ—¶çš„ä»»åŠ¡æ”¾åˆ°ä¸€è¾¹ï¼Œå…¶ä»–ä»»åŠ¡å…ˆè¿›è¡Œï¼Œç­‰å¤„ç†å®Œå…¶å®ƒä¸éœ€è¦ç­‰å¾…çš„ä»»åŠ¡å†å›å¤´æ¥è®¡ç®—åˆšåˆšè¢«æ”¾ä¸€è¾¹çš„ä»»åŠ¡ã€‚è¿™æ ·å°±ä¸ä¼šé˜»æ–­çº¿ç¨‹å•¦ã€‚

å°±åƒä¸Šé¢è®²è¿°çš„ï¼Œåé¢çš„ä»»åŠ¡éœ€è¦ç­‰ä¸Šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•æ‰ä¼šè¿›è¡Œï¼Œå«**åŒæ­¥ä»»åŠ¡**ï¼›æŠŠè¿™äº›éå¸¸è€—æ—¶çš„ä»»åŠ¡æ”¾åˆ°ä¸€è¾¹ï¼Œå…¶ä»–ä»»åŠ¡å…ˆè¿›è¡Œï¼Œå«**å¼‚æ­¥ä»»åŠ¡**ã€‚

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œ**æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡åä¼šå‘ç”Ÿä»€ä¹ˆ**ï¼Ÿ

## â˜ï¸ ä»»åŠ¡é˜Ÿåˆ—

åœ¨ä¸»çº¿ç¨‹ä¹‹å¤–å­˜åœ¨ä¸€ä¸ª**ä»»åŠ¡é˜Ÿåˆ—**ã€‚

å½“å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œä¼šå°†ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼ˆå›è°ƒå‡½æ•°æ˜¯åœ¨ç¼–å†™å¼‚æ­¥ä»»åŠ¡æ—¶æŒ‡å®šçš„ï¼Œç”¨æ¥å¤„ç†å¼‚æ­¥çš„ç»“æœï¼‰æ¨å…¥**ä»»åŠ¡é˜Ÿåˆ—**ï¼Œè¿™äº›å›è°ƒå‡½æ•°æ ¹æ®ç±»å‹ä¸åŒè¢«åˆ†é…åˆ° **task** å’Œ **microtask** ä¸­ï¼Œæœ€å…ˆè¢«æ¨å…¥çš„å‡½æ•°å…ˆè¢«æ¨å…¥ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œæ˜¯å…ˆè¿›å…ˆå‡ºçš„æ•°æ®ç»“æ„ã€‚ç”±äºæœ‰å®šæ—¶å™¨è¿™ç±»åŠŸèƒ½ï¼Œä¸»çº¿ç¨‹ä¸€èˆ¬è¦æ£€æŸ¥æ—¶é—´åï¼ŒæŸäº›ä»»åŠ¡æ‰ä¼šè¢«æ‰§è¡Œã€‚

## ğŸŒ§ äº‹ä»¶å¾ªç¯

ä¸€æ—¦ä¸»çº¿ç¨‹æ²¡ä»»åŠ¡äº†ï¼ŒJavaScript å¼•æ“å°±ä¼šå»è¯»å–ä»»åŠ¡é˜Ÿåˆ—ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šå¾ªç¯ä¸æ–­ï¼Œè¢«å«åšäº‹ä»¶å¾ªç¯ã€‚

ç”¨å›¾è¡¨ç¤ºï¼š

![eventLoop](Image/eventLoop.png)

## ğŸŒ© setTimeoutã€setInterval

ä¸Šæ–‡è®²çš„å®šæ—¶åŠŸèƒ½ï¼Œä¾é  setTimeoutã€setInterval æä¾›çš„å®šæ—¶åŠŸèƒ½ï¼ŒåŒºåˆ«åœ¨äº setTimeout åœ¨æŒ‡å®šæ—¶é—´åæ‰§è¡Œä¸€æ¬¡ï¼Œè€Œ setInterval åˆ™é‡å¤æ‰§è¡Œã€‚

setTimeout åœ¨ä»»åŠ¡é˜Ÿåˆ—å°¾éƒ¨æ·»åŠ äº†ä¸€ä¸ªäº‹ä»¶ï¼Œåœ¨è®¾å®šçš„æ—¶é—´åæ‰§è¡Œã€‚ä½†å®é™…æ²¡æœ‰è¿™ä¹ˆç†æƒ³ï¼Œå½“ä»»åŠ¡é˜Ÿåˆ—å‰é¢çš„ä»»åŠ¡éå¸¸è€—æ—¶ï¼Œå›è°ƒå‡½æ•°ä¸ä¸€å®šåœ¨è®¾ç½®çš„æ—¶é—´è¿è¡Œã€‚

æ‰€ä»¥å¸¸è§çš„å†™æ³• setTimeout(fn, 0)ï¼Œæ˜¯æŒ‡å®šæŸä¸ªä»»åŠ¡åœ¨ä¸»çº¿ç¨‹æœ€æ—©å¯å¾—çš„ç©ºé—²æ—¶é—´æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå°½å¯èƒ½æ—©å¾—æ‰§è¡Œã€‚

(æ³¨æ„ï¼šHTML5 æ ‡å‡†è§„å®šäº† setTimeout çš„ç¬¬äºŒä¸ªå‚æ•°çš„æœ€å°å€¼ï¼ˆæœ€çŸ­é—´éš”ï¼‰ï¼Œä¸å¾—ä½äº 4 æ¯«ç§’ï¼Œå¦‚æœä½äºè¿™ä¸ªå€¼ï¼Œå°±ä¼šè‡ªåŠ¨å¢åŠ ã€‚)

## â›ˆ microtask

JS çš„äº‹ä»¶å¾ªç¯æ‰§è¡Œæ—¶ä¼šåŒºåˆ† task å’Œ microtaskï¼Œå¼•æ“åœ¨æ¯ä¸ª task æ‰§è¡Œå®Œæ¯•ï¼Œä»é˜Ÿåˆ—ä¸­å–ä¸‹ä¸€ä¸ª task æ¥æ‰§è¡Œä¹‹å‰ï¼Œä¼šå…ˆæ‰§è¡Œå®Œæ‰€æœ‰ microtask é˜Ÿåˆ—ä¸­çš„ microtaskã€‚

ç”¨å›¾è¡¨ç¤ºï¼š

![eventLoop](Image/microtasks.png)

åƒæ•´ä½“ä»£ç  scriptï¼ŒsetTimeoutï¼ŒsetInterval è¿™äº›ä¼šè¢«åˆ†é…åˆ° task ä¸­æ‰§è¡Œï¼Œè€Œ process.nextTickã€Promise çš„ resolverã€MutationObserver çš„å›è°ƒéƒ½ä¼šè¢«åˆ†é…åˆ° microtask ä¸­æ‰§è¡Œã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

```js
console.log(1)

setTimeout(function st1() {
  console.log(2)
}, 0)

new Promise(solve => {
  console.log(3)
  solve(3)
}).then(function then1() {
  console.log(4)
  setTimeout(function st2() {
    console.log(5)
  }, 0)
})
```

ç¬¬1è½®ï¼š
1. ä»£ç è¿è¡Œï¼Œæ‰“å° 1
2. setTimeout å›è°ƒ st1 è¢«åˆ†é…åˆ° task

| task | microtask |
| ---- | --------- |
| st1  |           |

3. æ‰§è¡Œ new Promiseï¼Œæ‰“å° 3
4. é‡åˆ° then å›è°ƒè¢«åˆ†é…åˆ° microtask

| task | microtask |
| ---- | --------- |
| st1  | then1     |

5. å½“å‰ task æ‰§è¡Œå®Œæ¯•ï¼Œæ‰§è¡Œmicrotaské‡Œçš„ä»»åŠ¡then1ï¼Œæ‰“å° 4ï¼Œé‡åˆ° setTimeout å›è°ƒ st2 è¢«åˆ†é…åˆ° task

| task | microtask |
| ---- | --------- |
| st1  |           |
| st2  |           |


ç¬¬1è½®æ‰§è¡Œå®Œæ¯•ï¼Œæ‰“å°ï¼š1ï¼Œ3ï¼Œ4

ç¬¬2è½®ï¼š
1. æ£€æŸ¥ taskï¼Œå‘ç”Ÿæœ‰ st1ï¼Œæ‰“å°2
2. æ— microtask

ç¬¬2è½®æ‰§è¡Œå®Œæ¯•ï¼Œæ‰“å°ï¼š1ï¼Œ3ï¼Œ4ï¼Œ2


ç¬¬3è½®ï¼š
1. æ£€æŸ¥ taskï¼Œå‘ç”Ÿæœ‰ st2ï¼Œæ‰“å°5
2. æ— microtask

ç¬¬3è½®æ‰§è¡Œå®Œæ¯•ï¼Œæ‰“å°ï¼š1ï¼Œ3ï¼Œ4ï¼Œ2ï¼Œ5

**ä¸ºä»€ä¹ˆéœ€è¦ microtask** ï¼Ÿæ ¹æ® HTML Standardï¼Œåœ¨æ¯ä¸ª task è¿è¡Œå®Œä»¥åï¼ŒUI éƒ½ä¼šé‡æ¸²æŸ“ï¼Œé‚£ä¹ˆåœ¨ microtask ä¸­å°±å®Œæˆæ•°æ®æ›´æ–°ï¼Œå½“å‰ task ç»“æŸå°±å¯ä»¥å¾—åˆ°æœ€æ–°çš„ UI äº†ã€‚åä¹‹å¦‚æœæ–°å»ºä¸€ä¸ª task æ¥åšæ•°æ®æ›´æ–°ï¼Œé‚£ä¹ˆæ¸²æŸ“å°±ä¼šè¿›è¡Œä¸¤æ¬¡ã€‚

## ğŸš€ å‚è€ƒ

- [JavaScript è¿è¡Œæœºåˆ¶è¯¦è§£ï¼šå†è°ˆ Event Loop](http://www.ruanyifeng.com/blog/2014/10/event-loop.html) by é˜®ä¸€å³°
- [è¿™ä¸€æ¬¡ï¼Œå½»åº•å¼„æ‡‚ JavaScript æ‰§è¡Œæœºåˆ¶](https://juejin.im/post/59e85eebf265da430d571f89) by ssssyoki
- [å…³äº task å’Œ microtask çš„é—®ç­”](https://www.zhihu.com/question/55364497/answer/144215284) by é¡¾è½¶çµ
